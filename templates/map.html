<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Heat Map - Lead Finder</title>
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        overflow: hidden;
      }

      /* Header Bar */
      .header-bar {
        background: white;
        height: 60px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 20px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        z-index: 1001;
        position: relative;
      }

      .header-left {
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .admin-menu-btn {
        background: #667eea;
        color: white;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 1.2em;
      }

      .admin-menu-btn:hover {
        background: #5568d3;
      }

      .logo {
        font-size: 1.3em;
        font-weight: bold;
        color: #333;
      }

      .user-menu-btn {
        background: none;
        border: none;
        font-size: 1.5em;
        cursor: pointer;
        color: #333;
      }

      /* Main Container */
      .main-container {
        display: flex;
        height: calc(100vh - 60px);
      }

      /* Left Sidebar - CarMax Style */
      .left-sidebar {
        width: 320px;
        background: white;
        overflow-y: auto;
        border-right: 1px solid #e0e0e0;
        transition: transform 0.3s;
      }

      .left-sidebar.collapsed {
        transform: translateX(-320px);
      }

      .sidebar-section {
        padding: 20px;
        border-bottom: 1px solid #e0e0e0;
      }

      .sidebar-section h3 {
        font-size: 1.1em;
        margin-bottom: 15px;
        color: #333;
      }

      /* Search Bar */
      .search-box {
        position: relative;
        margin-bottom: 20px;
      }

      .search-box input {
        width: 100%;
        padding: 12px 40px 12px 15px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        font-size: 1em;
      }

      .search-box input:focus {
        outline: none;
        border-color: #667eea;
      }

      .search-box i {
        position: absolute;
        right: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #999;
      }

      /* Featured Options */
      .featured-options {
        display: flex;
        flex-direction: column;
        gap: 10px;
      }

      .featured-btn {
        padding: 12px;
        background: #f5f5f5;
        border: 2px solid transparent;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s;
        text-align: left;
        font-size: 0.95em;
      }

      .featured-btn:hover {
        background: #e8e8e8;
      }

      .featured-btn.active {
        background: #e7f3ff;
        border-color: #667eea;
        color: #667eea;
        font-weight: 600;
      }

      /* Filter Buttons */
      .filter-group {
        margin-bottom: 20px;
      }

      .filter-label {
        display: block;
        margin-bottom: 10px;
        font-weight: 600;
        color: #555;
        font-size: 0.9em;
      }

      .filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }

      .filter-btn {
        padding: 8px 16px;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 20px;
        cursor: pointer;
        font-size: 0.9em;
        transition: all 0.3s;
      }

      .filter-btn:hover {
        border-color: #667eea;
      }

      .filter-btn.active {
        background: #667eea;
        color: white;
        border-color: #667eea;
      }

      /* Refresh Button */
      .refresh-btn {
        width: 100%;
        padding: 12px;
        background: #667eea;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-size: 1em;
        font-weight: 600;
        margin-top: 15px;
      }

      .refresh-btn:hover {
        background: #5568d3;
      }

      /* Map Container */
      #map {
        flex: 1;
        height: 100%;
      }

      /* Admin Sidebar */
      .admin-sidebar {
        position: fixed;
        left: -300px;
        top: 60px;
        width: 300px;
        height: calc(100vh - 60px);
        background: white;
        box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
        transition: left 0.3s;
        z-index: 1000;
        overflow-y: auto;
        padding: 20px;
      }

      .admin-sidebar.open {
        left: 0;
      }

      .admin-sidebar h3 {
        margin-bottom: 15px;
        color: #333;
      }

      .stat-item {
        padding: 12px;
        background: #f5f5f5;
        border-radius: 8px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
      }

      /* User Menu */
      .user-menu {
        position: fixed;
        right: -350px;
        top: 60px;
        width: 350px;
        height: calc(100vh - 60px);
        background: #1a1a1a;
        color: white;
        box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        transition: right 0.3s;
        z-index: 1000;
        overflow-y: auto;
      }

      .user-menu.open {
        right: 0;
      }

      .user-profile {
        padding: 30px 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        text-align: center;
      }

      .user-avatar {
        width: 80px;
        height: 80px;
        border-radius: 50%;
        background: white;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2em;
        margin: 0 auto 15px;
      }

      .user-name {
        font-size: 1.2em;
        font-weight: 600;
        margin-bottom: 5px;
      }

      .menu-items {
        padding: 20px;
      }

      .menu-item {
        padding: 15px;
        border-bottom: 1px solid #333;
        cursor: pointer;
        display: flex;
        align-items: center;
        gap: 15px;
        transition: background 0.3s;
      }

      .menu-item:hover {
        background: #2a2a2a;
      }

      .menu-item i {
        font-size: 1.2em;
        color: #667eea;
      }

      .logout-btn {
        margin: 20px;
        padding: 12px;
        background: #dc3545;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        width: calc(100% - 40px);
        font-size: 1em;
      }

      .logout-btn:hover {
        background: #c82333;
      }

      /* Legend */
      .map-legend {
        position: absolute;
        bottom: 20px;
        left: 340px;
        background: white;
        padding: 15px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        z-index: 400;
      }

      .legend-title {
        font-weight: 600;
        margin-bottom: 10px;
        font-size: 0.9em;
      }

      .legend-item {
        display: flex;
        align-items: center;
        margin: 5px 0;
        font-size: 0.85em;
      }

      .legend-color {
        width: 25px;
        height: 15px;
        border-radius: 3px;
        margin-right: 8px;
      }

      /* Save Address Button */
      .save-address-btn {
        background: #28a745;
        color: white;
        border: none;
        padding: 8px 12px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 0.85em;
        margin-top: 10px;
      }

      .save-address-btn:hover {
        background: #218838;
      }

      @media (max-width: 768px) {
        .left-sidebar {
          position: absolute;
          z-index: 999;
          height: calc(100vh - 60px);
        }
        .map-legend {
          left: 20px;
        }
      }
    </style>
  </head>
  <body>
    <!-- Header -->
    <div class="header-bar">
      <div class="header-left">
        {% if current_user.is_admin %}
        <button class="admin-menu-btn" onclick="toggleAdminMenu()">
          <i class="fas fa-bars"></i>
        </button>
        {% endif %}
        <div class="logo">Lead Finder</div>
      </div>
      <button class="user-menu-btn" onclick="toggleUserMenu()">
        <i class="fas fa-user-circle"></i>
      </button>
    </div>

    <div class="main-container">
      <!-- Left Sidebar - Filters -->
      <div class="left-sidebar" id="leftSidebar">
        <!-- Search Section -->
        <div class="sidebar-section">
          <h3>Search Locations</h3>
          <div class="search-box">
            <input
              type="text"
              id="zip-search"
              placeholder="Enter ZIP code or city..."
            />
            <i class="fas fa-search"></i>
          </div>

          <div class="featured-options">
            <button class="featured-btn" onclick="setFeatured('high-income')">
              High Income Areas
            </button>
            <button class="featured-btn" onclick="setFeatured('suburban')">
              Suburban Neighborhoods
            </button>
            <button class="featured-btn" onclick="setFeatured('new-builds')">
              New Construction Zones
            </button>
          </div>
        </div>

        <!-- Income Filter -->
        <div class="sidebar-section">
          <div class="filter-group">
            <span class="filter-label">Income Level</span>
            <div class="filter-buttons">
              <button class="filter-btn" data-filter="income" data-value="low">
                &lt; $40k
              </button>
              <button
                class="filter-btn"
                data-filter="income"
                data-value="middle"
              >
                $40k-$75k
              </button>
              <button
                class="filter-btn"
                data-filter="income"
                data-value="upper"
              >
                $75k-$120k
              </button>
              <button class="filter-btn" data-filter="income" data-value="high">
                &gt; $120k
              </button>
            </div>
          </div>
        </div>

        <!-- Population Filter -->
        <div class="sidebar-section">
          <div class="filter-group">
            <span class="filter-label">Population Size</span>
            <div class="filter-buttons">
              <button
                class="filter-btn"
                data-filter="population"
                data-value="small"
              >
                &lt; 1,000
              </button>
              <button
                class="filter-btn"
                data-filter="population"
                data-value="medium"
              >
                1,000-10,000
              </button>
              <button
                class="filter-btn"
                data-filter="population"
                data-value="large"
              >
                &gt; 10,000
              </button>
            </div>
          </div>
        </div>

        <!-- Home Value Filter -->
        <div class="sidebar-section">
          <div class="filter-group">
            <span class="filter-label">Home Value</span>
            <div class="filter-buttons">
              <button
                class="filter-btn"
                data-filter="home-value"
                data-value="low"
              >
                &lt; $100k
              </button>
              <button
                class="filter-btn"
                data-filter="home-value"
                data-value="mid"
              >
                $100k-$200k
              </button>
              <button
                class="filter-btn"
                data-filter="home-value"
                data-value="high"
              >
                &gt; $200k
              </button>
            </div>
          </div>

          <button class="refresh-btn" onclick="refreshFilters()">
            <i class="fas fa-redo"></i> Reset All Filters
          </button>
        </div>
      </div>

      <!-- Map -->
      <div id="map"></div>

      <!-- Legend -->
      <div class="map-legend">
        <div class="legend-title">Lead Density</div>
        <div class="legend-item">
          <div class="legend-color" style="background: #dc3545"></div>
          <span>Low (&lt;$40k)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #ffc107"></div>
          <span>Middle ($40k-$75k)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #28a745"></div>
          <span>Upper ($75k-$120k)</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: #007bff"></div>
          <span>High (&gt;$120k)</span>
        </div>
      </div>
    </div>

    <!-- Admin Sidebar -->
    {% if current_user.is_admin %}
    <div class="admin-sidebar" id="adminSidebar">
      <h3>Admin Dashboard</h3>
      <div class="stat-item">
        <span>Total Users:</span>
        <strong id="admin-users">-</strong>
      </div>
      <div class="stat-item">
        <span>Locations:</span>
        <strong id="admin-locations">-</strong>
      </div>
      <div class="stat-item">
        <span>Demographics:</span>
        <strong id="admin-demographics">-</strong>
      </div>
      <div class="stat-item">
        <span>Saved Addresses:</span>
        <strong id="admin-saved">-</strong>
      </div>
    </div>
    {% endif %}

    <!-- User Menu -->
    <div class="user-menu" id="userMenu">
      <div class="user-profile">
        <div class="user-avatar">{{ current_user.username[0].upper() }}</div>
        <div class="user-name">{{ current_user.username }}</div>
        <div style="font-size: 0.9em; opacity: 0.9">
          {{ current_user.email or 'No email set' }}
        </div>
      </div>

      <div class="menu-items">
        <div class="menu-item" onclick="location.href='/profile'">
          <i class="fas fa-user-edit"></i>
          <span>Edit Profile</span>
        </div>
        <div class="menu-item" onclick="location.href='/search-history'">
          <i class="fas fa-history"></i>
          <span>Search History</span>
        </div>
        <div class="menu-item" onclick="location.href='/saved-addresses'">
          <i class="fas fa-bookmark"></i>
          <span>Saved Addresses</span>
        </div>
        {% if current_user.is_admin %}
        <div class="menu-item" onclick="location.href='/admin'">
          <i class="fas fa-shield-alt"></i>
          <span>Admin Panel</span>
        </div>
        {% endif %}
      </div>

      <form method="POST" action="{{ url_for('auth.logout') }}">
        <button type="submit" class="logout-btn">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </form>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      const map = L.map("map").setView([40.5, -95.0], 7);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        attribution: "Â© OpenStreetMap contributors",
        maxZoom: 18,
      }).addTo(map);

      let demographicCircles = [];
      let activeFilters = {
        income: [],
        population: [],
        homeValue: [],
        search: "",
      };

      const zipCoords = {
        50022: [41.5914, -94.7633],
        50025: [41.4036, -95.0139],
        50833: [41.4778, -95.3378],
        50837: [41.2292, -95.4169],
        50076: [41.2711, -94.8658],
        50839: [41.8203, -95.3414],
        50841: [41.7817, -95.4336],
        50117: [41.5911, -95.0589],
        50843: [41.1467, -95.1622],
        50846: [41.2336, -95.1386],
        50847: [41.3928, -95.3658],
        50848: [41.6531, -95.3256],
        50857: [41.305, -95.0847],
        50859: [41.4603, -95.1022],
        50862: [41.2539, -94.7692],
        50864: [41.3122, -95.3947],
        51520: [41.2619, -95.8608],
        51521: [41.2358, -95.8472],
        51523: [41.2878, -95.7961],
        51601: [40.7658, -95.3769],
        51631: [40.7406, -95.0372],
        51632: [40.6072, -95.6544],
        64501: [39.7684, -94.8467],
        64503: [39.7447, -94.8163],
        64504: [39.7905, -94.7961],
        64505: [39.7275, -94.8769],
        66027: [39.3111, -94.9225],
        66048: [39.3697, -94.9858],
        66002: [39.5631, -95.1218],
        66043: [39.3553, -94.9178],
        66012: [39.0589, -94.8836],
        64101: [39.0997, -94.5786],
        64112: [39.0399, -94.5919],
        64030: [38.8861, -94.5333],
        66207: [38.9822, -94.6708],
      };

      function getIncomeColor(income) {
        if (!income) return "#9e9e9e";
        if (income < 40000) return "#dc3545";
        if (income < 75000) return "#ffc107";
        if (income < 120000) return "#28a745";
        return "#007bff";
      }

      async function loadMapData() {
        const response = await fetch("/api/demographics");
        const data = await response.json();

        if (data.demographics) {
          data.demographics.forEach((demo) => {
            const coords = zipCoords[demo.zip_code];
            if (coords) {
              const color = getIncomeColor(demo.median_income);
              const radius = Math.sqrt(demo.population || 1000) * 30;

              const circle = L.circle(coords, {
                color: color,
                fillColor: color,
                fillOpacity: 0.6,
                radius: 1200,
                weight: 2,
              }).addTo(map);

              const currentFilters = JSON.stringify(activeFilters);

              circle.bindPopup(`
                            <div style="padding: 10px;">
                                <div style="font-weight: bold; font-size: 1.1em; margin-bottom: 8px;">
                                    ${demo.city}, ${demo.state} ${demo.zip_code}
                                </div>
                                <div style="margin: 4px 0;">Population: ${demo.population?.toLocaleString()}</div>
                                <div style="margin: 4px 0;">Median Income: $${demo.median_income?.toLocaleString()}</div>
                                <div style="margin: 4px 0;">Home Value: $${demo.median_home_value?.toLocaleString()}</div>
                                <button class="save-address-btn" onclick='saveAddress(${JSON.stringify(
                                  demo
                                )}, ${currentFilters})'>
                                    ðŸ’¾ Save This Area
                                </button>
                            </div>
                        `);

              demographicCircles.push({ circle, data: demo });
            }
          });
        }

        loadAdminStats();
      }

      // Filter buttons
      document.querySelectorAll(".filter-btn").forEach((btn) => {
        btn.addEventListener("click", function () {
          this.classList.toggle("active");
          applyFilters();
          saveSearchHistory();
        });
      });

      // Search
      document
        .getElementById("zip-search")
        .addEventListener("input", function () {
          activeFilters.search = this.value.toLowerCase();
          applyFilters();
        });

      function applyFilters() {
        const incomeFilters = Array.from(
          document.querySelectorAll('[data-filter="income"].active')
        ).map((b) => b.dataset.value);
        const popFilters = Array.from(
          document.querySelectorAll('[data-filter="population"].active')
        ).map((b) => b.dataset.value);
        const homeFilters = Array.from(
          document.querySelectorAll('[data-filter="home-value"].active')
        ).map((b) => b.dataset.value);

        demographicCircles.forEach(({ circle, data }) => {
          let show = true;

          if (incomeFilters.length > 0) {
            const income = data.median_income || 0;
            const matches = incomeFilters.some((f) => {
              if (f === "low") return income < 40000;
              if (f === "middle") return income >= 40000 && income < 75000;
              if (f === "upper") return income >= 75000 && income < 120000;
              if (f === "high") return income >= 120000;
              return false;
            });
            if (!matches) show = false;
          }

          if (popFilters.length > 0) {
            const pop = data.population || 0;
            const matches = popFilters.some((f) => {
              if (f === "small") return pop < 1000;
              if (f === "medium") return pop >= 1000 && pop < 10000;
              if (f === "large") return pop >= 10000;
              return false;
            });
            if (!matches) show = false;
          }

          if (homeFilters.length > 0) {
            const value = data.median_home_value || 0;
            const matches = homeFilters.some((f) => {
              if (f === "low") return value < 100000;
              if (f === "mid") return value >= 100000 && value < 200000;
              if (f === "high") return value >= 200000;
              return false;
            });
            if (!matches) show = false;
          }

          if (activeFilters.search) {
            const matchesZip = data.zip_code
              .toLowerCase()
              .includes(activeFilters.search);
            const matchesCity = data.city
              .toLowerCase()
              .includes(activeFilters.search);
            if (!matchesZip && !matchesCity) show = false;
          }

          if (show) {
            circle.addTo(map);
          } else {
            map.removeLayer(circle);
          }
        });
      }

      function refreshFilters() {
        document
          .querySelectorAll(".filter-btn")
          .forEach((btn) => btn.classList.remove("active"));
        document.getElementById("zip-search").value = "";
        activeFilters = {
          income: [],
          population: [],
          homeValue: [],
          search: "",
        };
        applyFilters();
      }

      function setFeatured(type) {
        refreshFilters();
        if (type === "high-income") {
          document
            .querySelector('[data-filter="income"][data-value="high"]')
            .classList.add("active");
        } else if (type === "suburban") {
          document
            .querySelector('[data-filter="population"][data-value="medium"]')
            .classList.add("active");
        }
        applyFilters();
      }

      function toggleAdminMenu() {
        document.getElementById("adminSidebar").classList.toggle("open");
      }

      function toggleUserMenu() {
        document.getElementById("userMenu").classList.toggle("open");
      }

      async function loadAdminStats() {
        try {
          const stats = await fetch("/api/admin/stats").then((r) => r.json());
          if (document.getElementById("admin-users")) {
            document.getElementById("admin-users").textContent =
              stats.users || 0;
            document.getElementById("admin-locations").textContent =
              stats.locations || 0;
            document.getElementById("admin-demographics").textContent =
              stats.demographics || 0;
            document.getElementById("admin-saved").textContent =
              stats.saved_addresses || 0;
          }
        } catch (e) {}
      }

      async function saveAddress(demo, filters) {
        const name = prompt(
          `Name this location (e.g., "Johnson Neighborhood"):`
        );
        if (!name) return;

        await fetch("/api/saved-addresses", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            name: name,
            address: `${demo.city}, ${demo.state}`,
            city: demo.city,
            state: demo.state,
            zip_code: demo.zip_code,
            address_type: "residential",
            filters_used: JSON.parse(filters),
          }),
        });

        alert("âœ… Address saved!");
      }

      async function saveSearchHistory() {
        const incomeFilters = Array.from(
          document.querySelectorAll('[data-filter="income"].active')
        ).map((b) => b.dataset.value);
        const popFilters = Array.from(
          document.querySelectorAll('[data-filter="population"].active')
        ).map((b) => b.dataset.value);

        await fetch("/api/search-history", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            filters: { income: incomeFilters, population: popFilters },
          }),
        });
      }

      loadMapData();

      // Close menus on click outside
      document.addEventListener("click", function (e) {
        if (
          !e.target.closest(".user-menu") &&
          !e.target.closest(".user-menu-btn")
        ) {
          document.getElementById("userMenu").classList.remove("open");
        }
        if (
          !e.target.closest(".admin-sidebar") &&
          !e.target.closest(".admin-menu-btn")
        ) {
          if (document.getElementById("adminSidebar")) {
            document.getElementById("adminSidebar").classList.remove("open");
          }
        }
      });
    </script>
  </body>
</html>
